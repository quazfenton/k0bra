apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: k0bra-ingress
  namespace: k0bra-system
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "1g"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - k0bra.example.com
    secretName: k0bra-tls
  rules:
  - host: k0bra.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: k0bra-service
            port:
              number: 80
      - path: /api/sandbox
        pathType: Prefix
        backend:
          service:
            name: sandbox-service
            port:
              number: 5001
      - path: /api/cache
        pathType: Prefix
        backend:
          service:
            name: build-cache-service
            port:
              number: 5003
      - path: /api/screenshot
        pathType: Prefix
        backend:
          service:
            name: screenshot-service
            port:
              number: 5005
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: k0bra-network-policy
  namespace: k0bra-system
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - namespaceSelector:
        matchLabels:
          name: k0bra-system
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: k0bra-system
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
